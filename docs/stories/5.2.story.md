# Story 5.2: Internationalization (i18n) Infrastructure

## Status

Done

## Story

**As a** developer,
**I want** a language context and content loading system,
**so that** the site can display content in multiple languages.

## Acceptance Criteria

1. `LanguageProvider` context manages current locale state
2. Browser locale auto-detected on first visit (navigator.language)
3. Language preference persists in localStorage
4. Content utility functions load JSON from language-specific directories
5. Default language is English when locale not supported
6. `html lang` attribute updates to reflect current language

## Tasks / Subtasks

- [x] Task 1: Create LanguageProvider Context (AC: 1, 2, 3, 5)
  - [x] 1.1 Create `components/providers/language-provider.tsx` with LanguageProvider component
  - [x] 1.2 Define locale types: `'en' | 'tr'` (English and Turkish)
  - [x] 1.3 Implement localStorage persistence with key `'scalenty-locale'`
  - [x] 1.4 Create `useLanguage` hook to access locale state and setter function
  - [x] 1.5 Implement browser locale detection via `navigator.language` on first visit
  - [x] 1.6 Map browser locale to supported locales (e.g., `tr-TR` → `tr`, `en-US` → `en`)
  - [x] 1.7 Default to `'en'` if browser locale is not supported
  - [x] 1.8 Add JSDoc documentation to all exports

- [x] Task 2: Implement Language Flash Prevention Script (AC: 2, 5)
  - [x] 2.1 Create inline `<script>` in `app/layout.tsx` head section (similar to theme script)
  - [x] 2.2 Script must run before React hydration to read localStorage and set initial `lang` attribute
  - [x] 2.3 Script must check `navigator.language` if no localStorage preference exists
  - [x] 2.4 Script must set `lang` attribute on `document.documentElement` to detected locale

- [x] Task 3: Update HTML Lang Attribute Dynamically (AC: 6)
  - [x] 3.1 LanguageProvider must update `document.documentElement.lang` when locale changes
  - [x] 3.2 Ensure attribute updates immediately on language toggle (client-side)

- [x] Task 4: Create Content Directory Structure for i18n (AC: 4)
  - [x] 4.1 Create `content/en/` directory (English content)
  - [x] 4.2 Move existing JSON files to `content/en/` preserving structure:
    - `content/en/services/amazon.json`
    - `content/en/services/etsy.json`
    - `content/en/pricing/packages.json`
    - `content/en/about.json`
    - `content/en/contact.json`
    - `content/en/faq.json`
    - `content/en/legal/privacy.json`
    - `content/en/legal/terms.json`
  - [x] 4.3 Create `content/tr/` directory (Turkish content) with same structure
  - [x] 4.4 Create placeholder Turkish JSON files (translations added in Story 5.3)

- [x] Task 5: Update Content Utility Functions (AC: 4, 5)
  - [x] 5.1 Update `lib/content.ts` to accept optional `locale` parameter
  - [x] 5.2 Create `getLocalizedContent(path: string, locale: Locale)` utility function
  - [x] 5.3 Update existing content accessors to use locale-aware loading:
    - `getAmazonServices(locale?: Locale)`
    - `getEtsyServices(locale?: Locale)`
    - `getAmazonPricingPackages(locale?: Locale)`
    - `getEtsyPricingPackages(locale?: Locale)`
    - `getAboutContent(locale?: Locale)`
    - `getContactContent(locale?: Locale)`
    - `getFAQs(locale?: Locale)`
    - `getPrivacyPolicyContent(locale?: Locale)`
    - `getTermsOfServiceContent(locale?: Locale)`
  - [x] 5.4 Default to `'en'` locale when not specified (backward compatibility)
  - [x] 5.5 Add fallback to English content if locale-specific file not found

- [x] Task 6: Create Locale Type Definitions (AC: 1)
  - [x] 6.1 Add `Locale` type to `lib/types.ts`: `'en' | 'tr'`
  - [x] 6.2 Add `SupportedLocales` constant array: `['en', 'tr']`
  - [x] 6.3 Add `DEFAULT_LOCALE` constant: `'en'`
  - [x] 6.4 Add JSDoc documentation for locale types

- [x] Task 7: Wrap App with LanguageProvider (AC: 1, 6)
  - [x] 7.1 Import LanguageProvider in `app/layout.tsx`
  - [x] 7.2 Wrap ThemeProvider with LanguageProvider (outermost)
  - [x] 7.3 Ensure proper provider nesting order

- [x] Task 8: Write Unit Tests (AC: 1, 2, 3, 4, 5, 6)
  - [x] 8.1 Create `tests/components/providers/language-provider.test.tsx`
  - [x] 8.2 Test: Initial render detects browser locale
  - [x] 8.3 Test: localStorage preference overrides browser locale
  - [x] 8.4 Test: Unsupported locale falls back to English
  - [x] 8.5 Test: setLocale updates state and localStorage
  - [x] 8.6 Test: html lang attribute updates on locale change
  - [x] 8.7 Create `tests/lib/content.test.ts` (extend existing or create new)
  - [x] 8.8 Test: Content accessor returns English content by default
  - [x] 8.9 Test: Content accessor returns Turkish content when specified
  - [x] 8.10 Test: Falls back to English when Turkish file missing

## Dev Notes

### Previous Story Insights (Story 5.1)
[Source: docs/stories/5.1.story.md#dev-agent-record]

- ThemeProvider pattern established: React Context + localStorage + inline script for flash prevention
- Provider nesting order: `ThemeProvider` > `CookieConsentProvider` > `PlausibleProvider` > components
- 387 tests passing with Vitest + React Testing Library
- Build output: 17 pages generated successfully
- `mounted` state pattern used to prevent hydration mismatches

### LanguageProvider Pattern (Follow ThemeProvider)
[Source: components/providers/theme-provider.tsx]

The LanguageProvider should follow the same patterns as ThemeProvider:
- `'use client'` directive at top
- React Context with `createContext`/`useContext`
- `mounted` state to prevent hydration mismatch
- `useCallback` for memoized functions
- localStorage for persistence
- Inline script in `<head>` for flash prevention

```typescript
// Example structure
export type Locale = 'en' | 'tr';

interface LanguageContextValue {
  locale: Locale;
  setLocale: (locale: Locale) => void;
}
```

### Browser Locale Detection
[Source: docs/prd/epic-details.md#technical-notes]

```typescript
// Detect and map browser locale
const getBrowserLocale = (): Locale => {
  if (typeof navigator === 'undefined') return 'en';
  const browserLang = navigator.language.toLowerCase();
  if (browserLang.startsWith('tr')) return 'tr';
  return 'en'; // Default to English for all other locales
};
```

### Inline Script for Language Flash Prevention
[Source: app/layout.tsx]

Similar to the theme script, add language detection before React hydrates:
```javascript
(function() {
  try {
    var stored = localStorage.getItem('scalenty-locale');
    var locale = stored;
    if (!locale) {
      var browserLang = navigator.language.toLowerCase();
      locale = browserLang.startsWith('tr') ? 'tr' : 'en';
    }
    document.documentElement.lang = locale;
  } catch (e) {}
})();
```

### Content Directory Structure
[Source: docs/prd/epic-details.md#technical-notes]

Current structure:
```
content/
├── services/
│   ├── amazon.json
│   └── etsy.json
├── pricing/
│   └── packages.json
├── about.json
├── contact.json
├── faq.json
└── legal/
    ├── privacy.json
    └── terms.json
```

Target structure:
```
content/
├── en/
│   ├── services/
│   │   ├── amazon.json
│   │   └── etsy.json
│   ├── pricing/
│   │   └── packages.json
│   ├── about.json
│   ├── contact.json
│   ├── faq.json
│   └── legal/
│       ├── privacy.json
│       └── terms.json
└── tr/
    └── (mirror structure - placeholder files for Story 5.3)
```

### Content Accessor Updates
[Source: lib/content.ts]

Current implementation imports JSON directly. For i18n, either:
1. **Dynamic imports** (recommended for SSG): Use `import()` with locale path
2. **Static imports with switch**: Import all locales, switch based on locale param

Since this is a static site with Next.js SSG, use dynamic imports:
```typescript
export async function getAmazonServices(locale: Locale = 'en'): Promise<Service[]> {
  try {
    const data = await import(`@/content/${locale}/services/amazon.json`);
    return data.default as Service[];
  } catch {
    // Fallback to English
    const data = await import(`@/content/en/services/amazon.json`);
    return data.default as Service[];
  }
}
```

**Note**: This changes functions from sync to async. Pages will need to await content.

### Provider Nesting Order
[Source: app/layout.tsx]

Current structure:
```tsx
<ThemeProvider>
  <CookieConsentProvider>
    <PlausibleProvider>
      <Header />
      <main>{children}</main>
      <Footer />
    </PlausibleProvider>
  </CookieConsentProvider>
</ThemeProvider>
```

Target structure (LanguageProvider as outermost):
```tsx
<LanguageProvider>
  <ThemeProvider>
    <CookieConsentProvider>
      <PlausibleProvider>
        <Header />
        <main>{children}</main>
        <Footer />
      </PlausibleProvider>
    </CookieConsentProvider>
  </ThemeProvider>
</LanguageProvider>
```

### Component File Locations
[Source: docs/architecture/unified-project-structure.md]

New files to create:
- `components/providers/language-provider.tsx` - LanguageProvider context and useLanguage hook

Files to modify:
- `app/layout.tsx` - Add inline language script and wrap with LanguageProvider
- `lib/content.ts` - Update all accessors to accept locale parameter
- `lib/types.ts` - Add Locale type and constants

Directories to restructure:
- `content/` → `content/en/` (move existing files)
- Create `content/tr/` (placeholder files)

### Accessibility Requirements
[Source: docs/architecture/coding-standards.md]

- `html lang` attribute MUST be set correctly for screen readers
- Attribute must update immediately when language changes
- Essential for proper pronunciation by screen reader software

## Testing

[Source: docs/architecture/testing-strategy.md]

### Test File Locations
- Provider tests: `tests/components/providers/language-provider.test.tsx`
- Content tests: `tests/lib/content.test.ts`

### Testing Framework
- Vitest + React Testing Library
- Mock `localStorage` using `vi.stubGlobal`
- Mock `navigator.language` for browser locale tests

### Test Patterns

**LanguageProvider Tests:**
```typescript
// Mock navigator.language
Object.defineProperty(navigator, 'language', {
  value: 'tr-TR',
  configurable: true,
});

// Mock localStorage
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
};
vi.stubGlobal('localStorage', localStorageMock);

// Test wrapper
const TestWrapper = ({ children }: { children: React.ReactNode }) => (
  <LanguageProvider>{children}</LanguageProvider>
);
```

**Content Tests:**
```typescript
import { getAmazonServices } from '@/lib/content';

describe('getAmazonServices', () => {
  it('returns English content by default', async () => {
    const services = await getAmazonServices();
    expect(services[0].title).toBe('Account Setup'); // English
  });

  it('returns Turkish content when specified', async () => {
    const services = await getAmazonServices('tr');
    expect(services[0].title).toBe('Hesap Kurulumu'); // Turkish
  });
});
```

### Commands
```bash
# Run all tests
npm run test:run

# Run specific test file
npm run test:run -- tests/components/providers/language-provider.test.tsx

# Run with coverage
npm run test:run -- --coverage
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 1.0 | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Build successful: 17 pages generated
- All 419 tests passing (57 test files)
- Lint: No ESLint warnings or errors

### Completion Notes List
- Implemented LanguageProvider with React Context + localStorage persistence
- Used static imports for content to avoid Vite dynamic import limitations in test environment
- Created content lookup map for efficient locale-based content retrieval
- Flash prevention script added in layout.tsx before React hydration
- LanguageProvider wraps ThemeProvider (outermost provider)
- Turkish content files are placeholders with English content (actual translations in Story 5.3)
- Content functions remain synchronous (changed from original async plan due to Vite compatibility)
- FAQ page refactored to server/client component pattern to support client-side filtering

### File List
**New Files:**
- `components/providers/language-provider.tsx` - LanguageProvider context and useLanguage hook
- `app/faq/faq-page-client.tsx` - Client component for FAQ filtering
- `content/en/services/amazon.json` - English Amazon services (moved)
- `content/en/services/etsy.json` - English Etsy services (moved)
- `content/en/pricing/packages.json` - English pricing (moved)
- `content/en/about.json` - English about content (moved)
- `content/en/contact.json` - English contact content (moved)
- `content/en/faq.json` - English FAQ content (moved)
- `content/en/legal/privacy.json` - English privacy policy (moved)
- `content/en/legal/terms.json` - English terms of service (moved)
- `content/tr/services/amazon.json` - Turkish Amazon services (placeholder)
- `content/tr/services/etsy.json` - Turkish Etsy services (placeholder)
- `content/tr/pricing/packages.json` - Turkish pricing (placeholder)
- `content/tr/about.json` - Turkish about content (placeholder)
- `content/tr/contact.json` - Turkish contact content (placeholder)
- `content/tr/faq.json` - Turkish FAQ content (placeholder)
- `content/tr/legal/privacy.json` - Turkish privacy policy (placeholder)
- `content/tr/legal/terms.json` - Turkish terms of service (placeholder)
- `tests/components/providers/language-provider.test.tsx` - LanguageProvider tests
- `tests/lib/content-i18n.test.ts` - i18n content tests

**Modified Files:**
- `lib/types.ts` - Added Locale type, SUPPORTED_LOCALES, DEFAULT_LOCALE
- `lib/content.ts` - Refactored to use static imports with locale map
- `app/layout.tsx` - Added language flash prevention script, wrapped with LanguageProvider
- `app/faq/page.tsx` - Refactored to server component
- `app/about/page.tsx` - Updated function signature
- `app/contact/page.tsx` - Updated function signature
- `app/pricing/page.tsx` - Updated function signature
- `app/privacy/page.tsx` - Updated function signature
- `app/terms/page.tsx` - Updated function signature
- `app/services/amazon/page.tsx` - Updated function signature
- `app/services/etsy/page.tsx` - Updated function signature
- `tests/lib/content-faq.test.ts` - Added locale tests
- `tests/lib/content-privacy.test.ts` - Added locale tests
- `tests/lib/content-terms.test.ts` - Added locale tests

**Deleted Files/Directories:**
- `content/services/` - Moved to `content/en/services/`
- `content/pricing/` - Moved to `content/en/pricing/`
- `content/legal/` - Moved to `content/en/legal/`
- `content/about.json` - Moved to `content/en/about.json`
- `content/contact.json` - Moved to `content/en/contact.json`
- `content/faq.json` - Moved to `content/en/faq.json`

---

## QA Results

### Review Date: 2025-12-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent implementation** of the i18n infrastructure. The code follows established patterns from Story 5.1 (ThemeProvider) and maintains consistency across the codebase.

**Strengths:**
- LanguageProvider follows the established ThemeProvider pattern with proper React Context usage
- Flash prevention script properly handles locale detection before React hydration
- Static imports approach solves Vite dynamic import limitations elegantly
- Content accessor functions maintain backward compatibility with default locale parameter
- Comprehensive JSDoc documentation throughout all new code
- Clean server/client component split for FAQ page

**Architecture Decisions (Well-Made):**
- Using static imports with a content map instead of dynamic imports was the right call for Vite compatibility
- LanguageProvider positioned as outermost provider (correct order)
- The `mounted` state pattern prevents hydration mismatches

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ All code follows TypeScript typing rules, JSDoc documentation, content accessor patterns
- Project Structure: ✓ Files placed correctly in `components/providers/`, content in `content/{locale}/`
- Testing Strategy: ✓ Unit tests cover provider behavior, content loading, and edge cases (419 tests passing)
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| AC1 | LanguageProvider context manages current locale state | ✓ PASS | [language-provider.tsx:75-121](components/providers/language-provider.tsx#L75-L121) - Context with locale/setLocale |
| AC2 | Browser locale auto-detected on first visit | ✓ PASS | [language-provider.tsx:44-49](components/providers/language-provider.tsx#L44-L49) - getBrowserLocale(), tests confirm detection |
| AC3 | Language preference persists in localStorage | ✓ PASS | [language-provider.tsx:86-94](components/providers/language-provider.tsx#L86-L94) - STORAGE_KEY='scalenty-locale' |
| AC4 | Content utility functions load JSON from language-specific directories | ✓ PASS | [content.ts:45-78](lib/content.ts#L45-L78) - contentMaps by locale |
| AC5 | Default language is English when locale not supported | ✓ PASS | [language-provider.tsx:48](components/providers/language-provider.tsx#L48) + [layout.tsx:103-105](app/layout.tsx#L103-L105) |
| AC6 | html lang attribute updates to reflect current language | ✓ PASS | [language-provider.tsx:80-82](components/providers/language-provider.tsx#L80-L82) + [layout.tsx:96-112](app/layout.tsx#L96-L112) |

### Test Coverage Analysis

| Test File | Tests | Coverage |
|-----------|-------|----------|
| language-provider.test.tsx | 12 | Browser detection, localStorage, fallback, lang attribute |
| content-i18n.test.ts | 14 | All content accessors, both locales, fallback behavior |
| content-faq.test.ts | 11 | FAQ accessors with locale support |
| content-privacy.test.ts | 7 | Privacy content with locale support |
| content-terms.test.ts | 7 | Terms content with locale support |

**Test Quality:** Tests properly mock localStorage and navigator.language, cover all edge cases including invalid localStorage values, unsupported locales, and locale variant mapping (tr-TR → tr).

### Improvements Checklist

All items addressed by the developer:

- [x] LanguageProvider implemented with proper React Context pattern
- [x] Flash prevention script added before React hydration
- [x] Content accessor functions updated with locale parameter
- [x] Content directory structure reorganized (content/{locale}/)
- [x] Turkish placeholder content created (translations in Story 5.3)
- [x] Comprehensive test coverage added
- [x] JSDoc documentation on all exports
- [x] FAQ page refactored to server/client component pattern

### Security Review

**Status: PASS**
- No security concerns identified
- localStorage access is properly wrapped in try/catch
- No sensitive data stored in locale preference
- No user input processed without validation

### Performance Considerations

**Status: PASS**
- Static imports ensure all content is bundled at build time
- No runtime fetches required for content loading
- Flash prevention script is minimal and synchronous
- LanguageProvider renders null until mounted (prevents flash)

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: PASS → docs/qa/gates/5.2-internationalization-infrastructure.yml

### Recommended Status

✓ Ready for Done

The implementation fully meets all acceptance criteria with comprehensive test coverage (419 tests passing), clean code following established patterns, and proper documentation. The Turkish content files are intentionally placeholders as translations are deferred to Story 5.3.
