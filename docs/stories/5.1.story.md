# Story 5.1: Dark Mode Implementation

## Status

Done

## Story

**As a** visitor,
**I want** the site to respect my system's dark/light preference and allow manual override,
**so that** I can browse comfortably in any lighting condition.

## Acceptance Criteria

1. Site respects `prefers-color-scheme` system preference on initial load
2. Dark mode toggle appears in header (desktop) and mobile nav drawer
3. Manual toggle overrides system preference and persists in localStorage
4. All existing components render correctly in both light and dark modes
5. No flash of wrong theme on page load (proper hydration)
6. Toggle uses appropriate icons (sun/moon) with smooth transition

## Tasks / Subtasks

- [x] Task 1: Create ThemeProvider Context (AC: 1, 3, 5)
  - [x] 1.1 Create `components/providers/theme-provider.tsx` with ThemeProvider component
  - [x] 1.2 Define theme types: `'light' | 'dark' | 'system'`
  - [x] 1.3 Implement localStorage persistence with key `'scalenty-theme'`
  - [x] 1.4 Create `useTheme` hook to access theme state and toggle function
  - [x] 1.5 Handle system preference detection via `window.matchMedia('(prefers-color-scheme: dark)')`
  - [x] 1.6 Apply `'dark'` class to `<html>` element based on resolved theme
  - [x] 1.7 Add JSDoc documentation to all exports

- [x] Task 2: Implement Theme Flash Prevention Script (AC: 5)
  - [x] 2.1 Create inline `<script>` in `app/layout.tsx` head section
  - [x] 2.2 Script must run before React hydration to read localStorage and set initial class
  - [x] 2.3 Script must check `prefers-color-scheme` if no localStorage preference exists
  - [x] 2.4 Script must add `'dark'` class to `document.documentElement` when dark mode detected

- [x] Task 3: Create Theme Toggle Component (AC: 2, 6)
  - [x] 3.1 Create `components/ui/theme-toggle.tsx` component
  - [x] 3.2 Use Sun and Moon icons from `lucide-react` (already installed)
  - [x] 3.3 Implement smooth icon transition animation using Tailwind
  - [x] 3.4 Toggle between light/dark (not system) on click for simplicity
  - [x] 3.5 Add proper accessibility: `aria-label`, keyboard support
  - [x] 3.6 Use shadcn/ui Button component with `variant="ghost"` and `size="icon"`
  - [x] 3.7 Add JSDoc documentation

- [x] Task 4: Integrate Theme Toggle into Header (AC: 2)
  - [x] 4.1 Import ThemeToggle component into `components/layout/header.tsx`
  - [x] 4.2 Add ThemeToggle to desktop navigation area (right side, before mobile menu trigger)
  - [x] 4.3 Ensure proper spacing and alignment with existing nav items

- [x] Task 5: Integrate Theme Toggle into Mobile Nav (AC: 2)
  - [x] 5.1 Import ThemeToggle component into `components/layout/mobile-nav.tsx`
  - [x] 5.2 Add ThemeToggle at bottom of mobile nav drawer content
  - [x] 5.3 Style appropriately for mobile context

- [x] Task 6: Wrap App with ThemeProvider (AC: 1, 3)
  - [x] 6.1 Import ThemeProvider in `app/layout.tsx`
  - [x] 6.2 Wrap existing providers with ThemeProvider
  - [x] 6.3 Ensure proper provider nesting order

- [x] Task 7: Verify Dark Mode Styling (AC: 4)
  - [x] 7.1 Test all pages in dark mode: Homepage, Services (Amazon/Etsy), Pricing, About, Contact, FAQ, Privacy, Terms
  - [x] 7.2 Verify shadcn/ui components render correctly (they use CSS variables)
  - [x] 7.3 Check for any hardcoded colors that need `dark:` variant
  - [x] 7.4 Verify images and illustrations have appropriate contrast
  - [x] 7.5 Fix any styling issues discovered

- [x] Task 8: Write Unit Tests (AC: 1, 2, 3, 4, 5, 6)
  - [x] 8.1 Create `tests/components/providers/theme-provider.test.tsx`
  - [x] 8.2 Test: Initial render respects system preference
  - [x] 8.3 Test: Toggle changes theme and updates DOM class
  - [x] 8.4 Test: Theme persists in localStorage
  - [x] 8.5 Test: localStorage preference overrides system preference
  - [x] 8.6 Create `tests/components/ui/theme-toggle.test.tsx`
  - [x] 8.7 Test: Toggle renders with correct icon based on theme
  - [x] 8.8 Test: Click handler calls theme toggle function
  - [x] 8.9 Test: Accessibility attributes present

## Dev Notes

### Previous Story Insights (Story 4.8)
[Source: docs/stories/4.8.story.md#dev-agent-record]

- All 365 tests passing with Vitest + React Testing Library
- Build output: 17 pages generated successfully
- Production site live at scalenty.net
- Provider architecture established: `CookieConsentProvider` > `PlausibleProvider` > components

### Existing Dark Mode Infrastructure
[Source: tailwind.config.ts]

Tailwind is **already configured** for class-based dark mode:
```typescript
darkMode: ["class"],
```

This means adding `class="dark"` to the `<html>` element will activate dark styles.

### Existing Dark CSS Variables
[Source: app/globals.css]

Dark mode CSS variables are **already defined**:
```css
.dark {
  --background: 222 47% 11%;
  --foreground: 210 40% 98%;
  --card: 222 47% 11%;
  --card-foreground: 210 40% 98%;
  --popover: 222 47% 11%;
  --popover-foreground: 210 40% 98%;
  --primary: 217 91% 60%;
  --primary-foreground: 0 0% 100%;
  --secondary: 215 28% 17%;
  --secondary-foreground: 210 40% 98%;
  --muted: 215 28% 17%;
  --muted-foreground: 215 20% 65%;
  --accent: 25 95% 53%;
  --accent-foreground: 0 0% 100%;
  --destructive: 0 62% 31%;
  --destructive-foreground: 210 40% 98%;
  --border: 215 28% 17%;
  --input: 215 28% 17%;
  --ring: 217 91% 60%;
  /* ... chart colors */
}
```

All shadcn/ui components use these CSS variables, so they will automatically adapt to dark mode.

### Component File Locations
[Source: docs/architecture/unified-project-structure.md]

New files to create:
- `components/providers/theme-provider.tsx` - ThemeProvider context and useTheme hook
- `components/ui/theme-toggle.tsx` - Theme toggle button component

Files to modify:
- `app/layout.tsx` - Add inline theme script and wrap with ThemeProvider
- `components/layout/header.tsx` - Add ThemeToggle to desktop nav
- `components/layout/mobile-nav.tsx` - Add ThemeToggle to mobile drawer

### State Management Pattern
[Source: docs/architecture/frontend-architecture.md#state-management-patterns]

- Use React Context for theme state (consistent with existing patterns)
- No global store needed - Context sufficient for theme state
- Use `useState` for current theme, `useEffect` for system preference listener

### Icon Library
[Source: package.json via existing components]

`lucide-react` is already installed and used throughout the project. Use:
- `Sun` icon for light mode indicator
- `Moon` icon for dark mode indicator

### Inline Script Pattern for Flash Prevention
[Source: docs/prd/epic-details.md#technical-notes]

From Epic 5 Technical Notes:
```
ThemeProvider manages: localStorage preference → system preference fallback → 'dark' class on <html>
Inline <script> in <head> prevents flash of wrong theme
```

The inline script must:
1. Be placed in `<head>` to run before body renders
2. Read `localStorage.getItem('scalenty-theme')`
3. If no stored preference, check `window.matchMedia('(prefers-color-scheme: dark)').matches`
4. Add `'dark'` class to `document.documentElement` if dark mode

### Provider Nesting Order
[Source: app/layout.tsx]

Current provider structure:
```tsx
<CookieConsentProvider>
  <PlausibleProvider>
    <Header />
    <main>{children}</main>
    <Footer />
  </PlausibleProvider>
</CookieConsentProvider>
```

ThemeProvider should wrap at the outermost level since it affects the entire UI:
```tsx
<ThemeProvider>
  <CookieConsentProvider>
    <PlausibleProvider>
      ...
    </PlausibleProvider>
  </CookieConsentProvider>
</ThemeProvider>
```

### shadcn/ui Button Reference
[Source: components/ui/button.tsx pattern]

Use existing Button component for toggle:
```tsx
<Button variant="ghost" size="icon" aria-label="Toggle theme">
  {theme === 'dark' ? <Sun className="h-5 w-5" /> : <Moon className="h-5 w-5" />}
</Button>
```

### Accessibility Requirements
[Source: docs/architecture/coding-standards.md]

- All interactive elements must be keyboard accessible
- Include proper `aria-label` for screen readers
- Icon-only buttons need descriptive labels

## Testing

[Source: docs/architecture/testing-strategy.md]

### Test File Locations
- Provider tests: `tests/components/providers/theme-provider.test.tsx`
- Toggle tests: `tests/components/ui/theme-toggle.test.tsx`

### Testing Framework
- Vitest + React Testing Library
- Mock `localStorage` using `vi.stubGlobal`
- Mock `matchMedia` for system preference tests

### Test Patterns

**ThemeProvider Tests:**
```typescript
// Mock matchMedia for system preference testing
Object.defineProperty(window, 'matchMedia', {
  value: vi.fn().mockImplementation((query) => ({
    matches: query === '(prefers-color-scheme: dark)',
    media: query,
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
  })),
});

// Mock localStorage
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
};
vi.stubGlobal('localStorage', localStorageMock);
```

**ThemeToggle Tests:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { ThemeToggle } from '@/components/ui/theme-toggle';
import { ThemeProvider } from '@/components/providers/theme-provider';

// Wrap in ThemeProvider for context
const renderWithProvider = (ui: React.ReactElement) => {
  return render(<ThemeProvider>{ui}</ThemeProvider>);
};
```

### Commands
```bash
# Run all tests
npm run test:run

# Run specific test file
npm run test:run -- tests/components/providers/theme-provider.test.tsx

# Run with coverage
npm run test:run -- --coverage
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 1.0 | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- Created ThemeProvider with `useTheme` hook, localStorage persistence (`scalenty-theme`), and system preference detection
- Added inline script in `<head>` to prevent flash of unstyled content (FOUC) on page load
- Created ThemeToggle component with animated Sun/Moon icons using Tailwind transitions
- Integrated toggle in desktop header (right side before mobile menu) and mobile nav drawer (bottom with label)
- Wrapped app with ThemeProvider as outermost provider
- Fixed Button component `secondary` and `ghost` variants to use CSS variables for dark mode compatibility
- Added global `matchMedia` mock to test setup for consistent test environment
- Updated existing header/mobile-nav tests to wrap with ThemeProvider
- All 387 tests passing, build successful (17 pages), no lint errors

### File List
**New Files:**
- `components/providers/theme-provider.tsx` - ThemeProvider context, useTheme hook
- `components/ui/theme-toggle.tsx` - Theme toggle button component
- `tests/components/providers/theme-provider.test.tsx` - 12 tests for ThemeProvider
- `tests/components/ui/theme-toggle.test.tsx` - 10 tests for ThemeToggle

**Modified Files:**
- `app/layout.tsx` - Added inline theme script, ThemeProvider wrapper, suppressHydrationWarning
- `components/layout/header.tsx` - Added ThemeToggle to desktop nav
- `components/layout/mobile-nav.tsx` - Added ThemeToggle to mobile drawer
- `components/ui/button.tsx` - Fixed secondary/ghost variants for dark mode
- `tests/setup.ts` - Added global matchMedia mock
- `tests/components/layout/header.test.tsx` - Wrapped tests with ThemeProvider
- `tests/components/layout/mobile-nav.test.tsx` - Wrapped tests with ThemeProvider
- `tests/components/ui/button.test.tsx` - Updated class assertions for new button variants

---

## QA Results

### Review Date: 2025-12-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation.** The dark mode feature is well-architected with clean separation of concerns:

- **ThemeProvider** (`components/providers/theme-provider.tsx`): Solid React Context implementation with proper TypeScript typing, memoized callbacks via `useCallback`, localStorage persistence, and system preference detection via `matchMedia`. The `mounted` state pattern correctly prevents hydration mismatches.

- **ThemeToggle** (`components/ui/theme-toggle.tsx`): Clean, accessible component using shadcn/ui Button with smooth CSS transitions for icon rotation/scaling. Proper `aria-label` updates based on current theme state.

- **Flash Prevention Script** (`app/layout.tsx`): Inline script correctly runs before React hydration to read localStorage and set the `dark` class on `<html>`, preventing FOUC. The `suppressHydrationWarning` attribute is appropriately used.

- **Integration**: ThemeToggle properly integrated in both desktop header and mobile nav drawer with appropriate positioning and styling.

### Refactoring Performed

None required - implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ All functions typed, JSDoc documentation present, no `any` usage, proper TypeScript throughout
- Project Structure: ✓ Files in correct locations (`components/providers/`, `components/ui/`), follows established patterns
- Testing Strategy: ✓ Comprehensive unit tests with proper mocking of localStorage and matchMedia
- All ACs Met: ✓ All 6 acceptance criteria fully implemented and verified

### Improvements Checklist

All items were implemented correctly by the developer:

- [x] ThemeProvider with localStorage persistence and system preference detection
- [x] Inline script for flash prevention
- [x] ThemeToggle with animated icons and accessibility
- [x] Desktop header integration
- [x] Mobile nav drawer integration
- [x] Comprehensive test coverage (22 tests across 2 files)
- [x] Button component variants updated for dark mode compatibility
- [x] Global matchMedia mock added to test setup

No additional improvements required.

### Security Review

✓ No security concerns. The implementation:
- Uses localStorage for non-sensitive preference data (appropriate)
- No external API calls or data transmission
- No user input beyond click events
- Inline script is self-contained with no external dependencies

### Performance Considerations

✓ No performance concerns:
- Inline theme script is minimal (~300 bytes)
- CSS transitions use GPU-accelerated properties (transform, opacity)
- `useCallback` prevents unnecessary re-renders
- Event listener properly cleaned up on unmount

### Files Modified During Review

None - no modifications needed.

### Gate Status

**Gate: PASS** → docs/qa/gates/5.1-dark-mode-implementation.yml

### Recommended Status

✓ **Ready for Done**

This is a well-executed feature implementation with comprehensive test coverage (22 new tests, all 387 tests passing), clean code architecture, proper accessibility, and no identified issues. The developer followed all coding standards and project patterns.
